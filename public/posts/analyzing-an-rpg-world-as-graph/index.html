<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Benjamin Clos">
    <meta name="description" content="My personal website">
    <meta name="keywords" content="blog,developer,personal">

    <base href="https://benjaminclos.com">
    <title>
  analyzing an RPG World as a Graph Â· tilde
</title>

    <link rel="canonical" href="https://benjaminclos.com/posts/analyzing-an-rpg-world-as-graph/">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" integrity="sha256-oSrCnRYXvHG31SBifqP2PM1uje7SJUyX0nTwO2RJV54=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://benjaminclos.com/css/coder.min.eed2c257f04d6434dadb0efa9a2b880efe926b9b1c0041bca61053be8f1cdfa1.css" integrity="sha256-7tLCV/BNZDTa2w76miuIDv6Sa5scAEG8phBTvo8c36E=" media="screen">
    

    

    
      <link rel="stylesheet" href="https://benjaminclos.com/css/app.css">
    

    <link rel="icon" type="image/png" href="https://benjaminclos.com/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://benjaminclos.com/images/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.48" />
  </head>

  <body class="">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://benjaminclos.com">
      tilde
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://benjaminclos.com/posts/">blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://benjaminclos.com/about/">about</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://benjaminclos.com/projects/">projects</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
  <article>
    <header>
      <h1 class="title">analyzing an RPG World as a Graph</h1>
      <h2 class="date">May 22, 2020</h2>

      
    </header>

    

<p>For those of you that don&rsquo;t know me, I have a lot of weird hobbies, one of those is playing a nearly 30 year old text-based Role Playing Game (RPG).  Archaic by most gamer&rsquo;s standards, the world is vastly different than most games, instead of being defined as an open map or grid, it is actually a <a href="https://en.wikipedia.org/wiki/Directed_graph">directed graph</a>.</p>

<h4 id="a-little-background">A Little Background</h4>

<p>The entirety of the graph is the <code>World</code> and the smallest component or node is known as a <code>Room</code>. Each <code>Room</code> belongs to a subgraph of known as a <code>Location</code> and each <code>Location</code> belongs to another subgraph known as a <code>Realm</code>.  The entire Graph is currently crawled by a crowd-sourced mapping system, which more or less acts like a Wiki for this Graph.  The graph is influenced by world events, and rooms can disappear, reappear, or generally change state, such as their cost function to traverse, without warning due to world events.  As with any crowd-sourcing there are data integrity issues and we wanted to visualize where bad <code>Location</code> data currently exists in the <code>World</code> and attempt to perhaps autocorrect some of it using a more modern approach.</p>

<h4 id="first-hurdle-translating-the-data-structures">First Hurdle - Translating the Data Structures</h4>

<p>Currently the <code>World</code> is stored in what most people might find to be odd format unless you have a lot of Ruby experience, this format is known as <a href="https://ruby-doc.org/core-2.7.1/Marshal.html">Marshal</a>.  I won&rsquo;t go into all the quirks, but the general idea is this provides a programmer a way to export a raw Ruby <code>Object</code> to a byte stream and be reconstituted in another process which has some advantages and disadvantages.  Analyzing it required writing a a couple <a href="https://github.com/elanthia-online/cartograph/tree/master/shims">small shims</a> enabling me to serialize the data from disk outside of the context of the gaming engine that powers most scripting.</p>

<h4 id="first-take">First Take</h4>

<p>The first take was terrible, I had totally underestimated how gnarly the graph actually was after 30 years.  It has dozens of orphaned <code>Location</code> definitions from areas that had been destroyed during world events, but are still maintained in the database.  I had to prune the graph to something reasonable, which really just came down to a few rules.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">valid_rooms = rooms.select {|r| 
  r.location.is_a?(<span style="color:#fff;font-weight:bold">String</span>) and       <span style="color:#007f7f"># non-string bad</span>
  !r.location.empty? and             <span style="color:#007f7f"># empty string bad</span>
  r.location !~ <span style="color:#0ff;font-weight:bold">/, (outside|inside)/</span> <span style="color:#007f7f"># unreachable areas</span>
}</code></pre></div>
<p>This gave me a first step towards a reasonable graph, the next steph was transforming the data into the structure we cared to analyze, a list of rooms isn&rsquo;t what we want, we can them organized by <code>Location</code>.  Luckily in Ruby there is a handy <a href="https://ruby-doc.org/core-2.7.1/Enumerable.html#method-i-group_by"><code>Enumerable#group_by</code></a> method.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#007f7f"># Hash of LocationName =&gt; Array(Room)</span>
rooms_by_location = valid_rooms.group_by(&amp;<span style="color:#0ff;font-weight:bold">:location</span>) </code></pre></div>
<p>The next step we wanted to apply was finding the rooms in the location that connect us to another location, we care about the edges of the subgraph (Location) not all rooms in any location</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#007f7f"># a little lambda to keep it readable</span>
is_on_boundary? -&gt; room {
  room.edges.any? <span style="color:#fff;font-weight:bold">do</span> |edge| edge.location != room.location <span style="color:#fff;font-weight:bold">end</span>
}
<span style="color:#007f7f"># Hash of LocationName =&gt; Array(BoundaryRoom)</span>
location_and_boundaries = rooms_by_location.map <span style="color:#fff;font-weight:bold">do</span> |location, rooms| 
  {   <span style="color:#0ff;font-weight:bold">location</span>: location, 
    <span style="color:#0ff;font-weight:bold">boundaries</span>: rooms.select <span style="color:#fff;font-weight:bold">do</span> |room| is_on_boundary?.(room) <span style="color:#fff;font-weight:bold">end</span>
  }
<span style="color:#fff;font-weight:bold">end</span></code></pre></div>
<p>It turned out there were still a lot of orphaned locations where their boundary edges were empty, so I had to apply another filter to prune them.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">non_orpaned_locations = location_and_boundaries.reject { |location| 
  location[<span style="color:#0ff;font-weight:bold">:boundaries</span>].empty?
}</code></pre></div>
<p>Now, we have something we can maybe, actually vizualize?  I started into looking at what libaries were out there, and found the <a href="https://graphviz.org/"><code>graphviz library</code></a> which had <a href="https://github.com/glejeune/Ruby-Graphviz">ruby bindings</a>, so I figured I&rsquo;d give it a shot.</p>

<p>First, I needed to translate my graph objects into what <code>graphviz</code> expects:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">viz = GraphViz.new(<span style="color:#0ff;font-weight:bold">:G</span>, <span style="color:#0ff;font-weight:bold">:type</span> =&gt; <span style="color:#0ff;font-weight:bold">:digraph</span>)
graph.each {|location| viz.add_node(location[<span style="color:#0ff;font-weight:bold">:location</span>])}
graph.each <span style="color:#fff;font-weight:bold">do</span> |location| 
  location[<span style="color:#0ff;font-weight:bold">:boundaries</span>].keys.each { |boundary| 
    viz.add_edges(location[<span style="color:#0ff;font-weight:bold">:location</span>], boundary)
  } 
<span style="color:#fff;font-weight:bold">end</span>
viz.output(<span style="color:#0ff;font-weight:bold">png</span>: <span style="color:#0ff;font-weight:bold">&#34;locations.png&#34;</span>)</code></pre></div>
<p>Which gave me this <em>lovely</em> output:</p>

<p><img src="/images/all-world-locations.png" alt="all locations in the world" /></p>

<p>Clearly I needed a different strategy because this vizualization was not very useful for vizualising much of anything, and that&rsquo;s when I went to bed.</p>

<h3 id="to-be-continued">&hellip;To Be Continued</h3>

  </article>

  <br/>

  
  
</section>

      </div>

      <footer class="footer">
  <section class="container">
    
     
  </section>
</footer>

    </main>

    

  </body>

</html>
